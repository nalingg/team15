<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>V-League Rollup 분석</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { padding: 20px; font-family: 'Inter', sans-serif; }
        .container { max-width: 960px; }

        /* 테이블 열 비율 및 가운데 정렬 */
        .col-rank { width: 10%; text-align: center; }
        .col-team { width: 40%; text-align: center; }
        .col-metric-main { width: 35%; text-align: center; }
        .col-drilldown { width: 15%; text-align: center; }

        /* 라디오 버튼 선택 시 강조 효과 */
        .btn-check:checked + .btn-outline-primary {
            background-color: var(--bs-primary);
            color: white;
            border-color: var(--bs-primary);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
        }
    </style>
</head>
<body>

<div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="dashboard.html">V-League 스카우팅 툴</a>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="dashboard.html">대시보드</a></li>
                        <li class="nav-item"><a class="nav-link" href="player_profile.html">선수 정보</a></li>
                        <li class="nav-item"><a class="nav-link active" href="analysis_value.html">고급 분석</a></li>
                    </ul>
                    <a href="login.html" class="btn btn-outline-light">로그아웃</a>
                </div>
            </div>
        </nav>

    <h1 class="mb-4 display-6 fw-bold text-primary text-center">팀별 스탯 순위 분석</h1>

    <!-- 분석 항목 선택 -->
    <div class="mb-5 p-4 bg-light border rounded shadow-sm text-center">
        <h5 class="mb-3 text-dark">분석 영역</h5>
        <div class="btn-group" role="group" id="metric-selector">
            <input type="radio" class="btn-check" name="metric" id="metric_score" value="score" autocomplete="off" checked>
            <label class="btn btn-outline-primary rounded-pill px-4 me-2" for="metric_score">득점 종합</label>

            <input type="radio" class="btn-check" name="metric" id="metric_defense" value="defense" autocomplete="off">
            <label class="btn btn-outline-primary rounded-pill px-4 me-2" for="metric_defense">수비 도움</label>

            <input type="radio" class="btn-check" name="metric" id="metric_setting" value="setting" autocomplete="off">
            <label class="btn btn-outline-primary rounded-pill px-4" for="metric_setting">세팅 도움</label>
        </div>
    </div>

    <!-- 결과 테이블 -->
    <h4 id="table-title" class="mb-3 text-secondary text-start">데이터 로드 중...</h4>

    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle text-center shadow-lg rounded-3 overflow-hidden">
            <thead class="table-dark">
                <tr>
                    <th scope="col" class="col-rank">순위</th>
                    <th scope="col" class="col-team">팀명</th>
                    <th scope="col" class="col-metric-main" id="metric-col-title">총 득점</th>
                    <th scope="col" class="col-drilldown">Drilldown</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                <tr>
                    <td colspan="4" class="text-center py-4 text-muted">데이터를 불러오는 중입니다...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="status-message" class="alert alert-info mt-4 text-center" role="alert">
        데이터 로드 대기 중...
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript 로직 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const statusMessageEl = document.getElementById('status-message');
    const dataTableBodyEl = document.getElementById('data-table-body');
    const tableTitleEl = document.getElementById('table-title');
    const metricColTitleEl = document.getElementById('metric-col-title');
    const metricSelectorEl = document.getElementById('metric-selector');
    const PHP_API_URL = 'fetch_rollup_data.php';

    // URL param 체크
    const urlParams = new URLSearchParams(window.location.search);
    const initialMetricFromUrl = urlParams.get('metric');

    // URL 기준으로 metric radio 체크
    if (initialMetricFromUrl) {
        const inputEl = metricSelectorEl.querySelector(`#metric_${initialMetricFromUrl}`);
        if (inputEl) inputEl.checked = true;
    }

    // 초기 metric 결정
    const initialMetric = initialMetricFromUrl 
        ? initialMetricFromUrl 
        : metricSelectorEl.querySelector('input:checked').value;

    // URL 동기화
    history.replaceState(null, "", `?metric=${initialMetric}`);

    // 첫 데이터 로드
    fetchAndRenderRollupData(initialMetric);

    // metric 변경 시 처리
    metricSelectorEl.addEventListener('change', (event) => {
        if (event.target.name === 'metric') {
            const newMetric = event.target.value;
            history.replaceState(null, "", `?metric=${newMetric}`);
            fetchAndRenderRollupData(newMetric);
        }
    });

    // Ajax + Table Rendering
    async function fetchAndRenderRollupData(metric) {
        statusMessageEl.className = 'alert alert-info mt-4 text-center';
        statusMessageEl.textContent = `${metric} 데이터를 불러오는 중...`;

        dataTableBodyEl.innerHTML = `
            <tr><td colspan="4" class="text-center py-5">
                <div class="spinner-border" role="status"></div>
            </td></tr>
        `;

        try {
            const response = await fetch(`${PHP_API_URL}?metric=${metric}`);
            if (!response.ok) throw new Error(`HTTP 오류: ${response.status}`);

            const result = await response.json();
            if (result.error) throw new Error(result.error);

            tableTitleEl.textContent = result.title;
            metricColTitleEl.textContent = result.main_metric_name;

            let htmlContent = '';
            result.data.forEach((team, index) => {
                const isTotalRow = team.team_id === 'TOTAL';
                const rank = isTotalRow ? '-' : (index + 1);
                const drilldownContent = isTotalRow 
                    ? '-' 
                    : `<a href="drilldown.html?teamId=${team.team_id}&teamName=${encodeURIComponent(team.team_name)}&metric=${metric}" 
   class="btn btn-sm btn-info text-white shadow-sm">보기</a>
`;

                htmlContent += `
                    <tr class="${isTotalRow ? 'table-secondary fw-bold' : ''}">
                        <td>${rank}</td>
                        <td>${isTotalRow ? '전체 합계' : team.team_name}</td>
                        <td class="fw-bold text-primary">${team.main_metric.toLocaleString('ko-KR')}</td>
                        <td>${drilldownContent}</td>
                    </tr>
                `;
            });

            dataTableBodyEl.innerHTML = htmlContent;
            statusMessageEl.className = 'alert alert-success mt-4 text-center';
            statusMessageEl.textContent = `✅ ${result.title} 로드 완료 (${result.data.length}개 팀)`;

        } catch (error) {
            statusMessageEl.className = 'alert alert-danger mt-4 text-center';
            statusMessageEl.textContent = `❌ 데이터 로드 실패: ${error.message}`;
            console.error(error);
        }
    }
});

</script>

</body>
</html>
